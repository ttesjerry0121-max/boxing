<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cyberpunk Boxing: Offline Ready</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap');

        body {
            margin: 0;
            padding: 0;
            background-color: #050510;
            background-image: 
                linear-gradient(rgba(0, 20, 30, 0.9), rgba(0, 10, 20, 0.95)),
                url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDQwIDQwIj48ZyBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxwYXRoIGQ9Ik0wIDQwTDQwIDBIMHoiIGZpbGw9IiMwZmYiIGZpbGwtb3BhY2l0eT0iMC4wNSIvPjwvZz48L3N2Zz4=');
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            font-family: "Orbitron", "Noto Sans TC", sans-serif;
            color: white;
            user-select: none;
        }

        #game-wrapper {
            position: relative;
            width: 900px;
            height: 600px;
            box-shadow: 0 0 50px rgba(0, 255, 255, 0.15), 0 0 20px rgba(0, 0, 0, 0.8);
            border: 1px solid #333;
            background: #000;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* UI å±¤ */
        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(5, 5, 10, 0.92);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 50;
            transition: opacity 0.3s;
        }
        .hidden { opacity: 0; pointer-events: none; z-index: -1; }

        h1 {
            color: #0ff;
            font-size: 56px;
            margin: 0 0 10px 0;
            text-shadow: 0 0 20px rgba(0, 255, 255, 0.8);
            text-align: center;
            font-family: 'Orbitron', sans-serif;
        }
        h2 { font-size: 20px; color: #aaa; margin-bottom: 40px; text-transform: uppercase; letter-spacing: 5px; }

        /* æŒ‰éˆ• */
        .btn-menu {
            background: rgba(0, 255, 255, 0.1);
            border: 2px solid #0ff;
            color: #0ff;
            padding: 15px 40px;
            font-size: 20px;
            font-weight: bold;
            margin: 10px;
            cursor: pointer;
            width: 280px;
            transition: all 0.2s;
            font-family: 'Noto Sans TC', sans-serif;
        }
        .btn-menu:hover:not(:disabled) {
            background: #0ff;
            color: #000;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.6);
            transform: translateY(-2px);
        }
        .btn-menu:disabled {
            border-color: #444;
            color: #666;
            background: rgba(0,0,0,0.5);
            cursor: not-allowed;
        }
        
        .btn-secondary {
            border-color: #555;
            color: #aaa;
            background: transparent;
        }
        .btn-secondary:hover {
            border-color: #fff;
            color: #fff;
        }

        /* ç‹€æ…‹åˆ— */
        .top-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 15px;
            box-sizing: border-box;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            pointer-events: none;
        }
        .top-btn {
            pointer-events: auto;
            background: rgba(0,0,0,0.6);
            border: 1px solid #444;
            color: #888;
            padding: 5px 12px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 5px;
        }
        .top-btn.active { border-color: #0ff; color: #0ff; }

        .status-pill {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #333;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            color: #888;
        }
        .status-pill.offline { border-color: #555; color: #aaa; }
        .status-pill.online { border-color: #0f0; color: #0f0; }

        /* AI è³½è©• */
        #ai-commentary-box {
            position: absolute;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            width: 600px;
            background: rgba(0, 20, 40, 0.8);
            border: 1px solid #0ff;
            border-radius: 5px;
            padding: 10px;
            text-align: center;
            pointer-events: none;
            z-index: 90;
            opacity: 0;
            transition: opacity 0.5s;
        }
        #ai-text { color: #fff; text-shadow: 0 0 5px #0ff; font-size: 16px; }
        
        /* è¦å‰‡ */
        .rules-card {
            border: 1px solid #ffe600;
            background: rgba(20, 20, 25, 0.95);
            padding: 30px;
            max-width: 600px;
            width: 90%;
        }
        .rule-item { margin-bottom: 15px; border-left: 3px solid #ffe600; padding-left: 10px; text-align: left; }
        .highlight { color: #fff; font-weight: bold; }
        
        /* è¼¸å…¥æ¡† */
        .input-code {
            background: #222; border: 1px solid #0ff; color: #fff; 
            font-size: 24px; text-align: center; width: 150px; padding: 5px;
        }
        .room-code-display { font-size: 60px; color: #ffe600; font-weight: bold; margin: 20px; }
    </style>
</head>
<body>

<div id="game-wrapper">
    <!-- é ‚éƒ¨åˆ— -->
    <div class="top-bar">
        <div style="display:flex; gap:10px;">
            <div id="connection-status" class="status-pill offline">é›¢ç·šæ¨¡å¼ (Offline)</div>
        </div>
        <div style="pointer-events: auto;">
            <button id="btn-ai" class="top-btn active" onclick="toggleAI()">âœ¨ AI è³½è©•</button>
            <button class="top-btn" onclick="toggleRules()">â“ è¦å‰‡</button>
            <button id="btn-music" class="top-btn active">ğŸµ BGM</button>
            <button id="btn-sfx" class="top-btn active">ğŸ”Š SFX</button>
        </div>
    </div>

    <!-- AI è³½è©•å€ -->
    <div id="ai-commentary-box">
        <div style="font-size:10px; color:#ffe600; margin-bottom:5px;">AI ANALYZER</div>
        <div id="ai-text">ç³»çµ±é€£ç·šä¸­...</div>
    </div>

    <!-- ä¸»é¸å–® -->
    <div id="ui-menu" class="ui-layer">
        <h1>CYBERPUNK BOXING</h1>
        <h2>NEON STRIKE ARENA</h2>
        
        <button class="btn-menu" onclick="startGame('single')">å–®äººé—–é—œ (PvE)</button>
        <button id="btn-multi" class="btn-menu" disabled onclick="showLobby()">
            å¤šäººé€£ç·š (éœ€ä¼ºæœå™¨)
        </button>
        <button class="btn-menu btn-secondary" onclick="toggleRules()">éŠæˆ²èªªæ˜</button>
        
        <div style="margin-top: 30px; font-size: 12px; color: #555;">v5.3 Fixed MAX_HP</div>
    </div>

    <!-- é€£ç·šå¤§å»³ (é›¢ç·šæ™‚ä¸æœƒé¡¯ç¤º) -->
    <div id="ui-lobby" class="ui-layer hidden">
        <h1>BATTLE LOBBY</h1>
        <div id="lobby-main">
            <button class="btn-menu" onclick="window.createRoom()">å»ºç«‹æˆ¿é–“</button>
            <div style="margin:10px; color:#666;">- OR -</div>
            <input type="number" id="room-input" class="input-code" placeholder="0000" maxlength="4">
            <br><br>
            <button class="btn-menu" onclick="window.joinRoom()">åŠ å…¥æˆ°å±€</button>
            <br><br>
            <button class="btn-menu btn-secondary" onclick="showMenu()">è¿”å›</button>
        </div>
        <div id="lobby-wait" class="hidden" style="text-align: center;">
            <div style="color:#0ff;">WAITING FOR OPPONENT</div>
            <div id="room-code-display" class="room-code-display">----</div>
            <button class="btn-menu btn-secondary" onclick="location.reload()">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- è¦å‰‡ -->
    <div id="ui-rules" class="ui-layer hidden">
        <div class="rules-card">
            <h2 style="color:#ffe600; text-align:center;">æˆ°é¬¥æ‰‹å†Š</h2>
            <div class="rule-item">
                <div style="color:#ffe600; font-weight:bold;">ğŸ”µ æ™®é€šé˜²ç¦¦</div>
                <div style="color:#ccc;">æ“‹ä½ <span class="highlight">æ™®æ”»ã€æŠ€1ã€æŠ€2</span>ã€‚<br>âš ï¸ æ“‹ä¸ä½ [æŠ€3]ã€‚</div>
            </div>
            <div class="rule-item">
                <div style="color:#ffe600; font-weight:bold;">ğŸŸ£ è¶…ç´šé˜²å®ˆ</div>
                <div style="color:#ccc;">å°ˆé–€æ“‹ <span class="highlight">æŠ€3 (å¤§æ‹›)</span>ã€‚<br>âš ï¸ æ“‹ä¸ä½å…¶ä»–æ”»æ“Šã€‚</div>
            </div>
            <div class="rule-item">
                <div style="color:#ffe600; font-weight:bold;">âš¡ é›†æ°£</div>
                <div style="color:#ccc;">è¢« <span class="highlight">æŠ€èƒ½</span> æ“Šä¸­æœƒä¸­æ–·ã€‚<br>è¢«æ™®æ”»æ‰“ä¸­ä¸æœƒæ–·ã€‚</div>
            </div>
            <div style="text-align:center; margin-top:20px;">
                <button class="btn-menu" onclick="toggleRules()">OK</button>
            </div>
        </div>
    </div>

    <!-- çµç®— -->
    <div id="ui-result" class="ui-layer hidden" style="background: rgba(0,0,0,0.85);">
        <h1 id="result-title">YOU WIN</h1>
        <button class="btn-menu" onclick="restartGame()">å†ä¾†ä¸€å±€</button>
        <button class="btn-menu btn-secondary" onclick="location.reload()">é›¢é–‹</button>
    </div>

    <canvas id="gameCanvas" width="900" height="600"></canvas>
</div>

<!-- ç³»çµ±æ ¸å¿ƒ -->
<script>
    function showMenu() { document.querySelectorAll('.ui-layer').forEach(e=>e.classList.add('hidden')); document.getElementById('ui-menu').classList.remove('hidden'); }
    function showLobby() { document.getElementById('ui-menu').classList.add('hidden'); document.getElementById('ui-lobby').classList.remove('hidden'); }
    function toggleRules() { document.getElementById('ui-rules').classList.toggle('hidden'); }
    
    // AI æ§åˆ¶
    let isAiOn = true;
    function toggleAI() {
        isAiOn = !isAiOn;
        const btn = document.getElementById('btn-ai');
        btn.classList.toggle('active');
        btn.innerText = isAiOn ? "âœ¨ AI è³½è©•: é–‹" : "âœ¨ AI è³½è©•: é—œ";
        if(!isAiOn) document.getElementById('ai-commentary-box').style.opacity = 0;
    }
</script>

<!-- Gemini API (Optional) -->
<script type="module">
    // å¦‚æœä½ æœ‰ API Keyï¼Œè«‹å¡«å…¥ä¸‹æ–¹å¼•è™Ÿä¸­
    const apiKey = ""; 

    window.callGeminiCommentary = async (promptText) => {
        if (!isAiOn || !apiKey) return;
        const box = document.getElementById('ai-commentary-box');
        const txt = document.getElementById('ai-text');
        
        box.style.opacity = 1;
        txt.innerText = "åˆ†æä¸­...";

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
            });
            const data = await response.json();
            const commentary = data.candidates?.[0]?.content?.parts?.[0]?.text;
            if(commentary) txt.innerText = commentary;
        } catch (e) {
            // console.error(e);
            txt.innerText = "AI é€£ç·šä¸­æ–·";
        }
    };
</script>

<!-- Firebase æ¨¡çµ„ (åŒ…å«éŒ¯èª¤è™•ç†) -->
<script type="module">
    // å˜—è©¦å‹•æ…‹åŒ¯å…¥ï¼Œå¦‚æœç’°å¢ƒä¸æ”¯æ´æœƒè¢« Catch
    let app, auth, db, appId;
    let currentUser = null, currentRoomId = null, myRole = null;
    let isFirebaseAvailable = false;

    // å®šç¾©å‡çš„å…¨åŸŸå‡½å¼ï¼Œé˜²æ­¢æŒ‰éˆ•å ±éŒ¯
    window.createRoom = () => alert("é›¢ç·šæ¨¡å¼ç„¡æ³•å»ºç«‹æˆ¿é–“");
    window.joinRoom = () => alert("é›¢ç·šæ¨¡å¼ç„¡æ³•åŠ å…¥æˆ¿é–“");

    try {
        // æª¢æŸ¥è¨­å®šæ˜¯å¦å­˜åœ¨ (æœ¬æ©Ÿæª”æ¡ˆé€šå¸¸æ²’æœ‰é€™å€‹)
        if (typeof __firebase_config === 'undefined') {
            throw new Error("Local Mode");
        }

        const { initializeApp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
        const { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
        const { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");

        const conf = JSON.parse(__firebase_config);
        app = initializeApp(conf);
        auth = getAuth(app);
        db = getFirestore(app);
        appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        isFirebaseAvailable = true;

        // ç™»å…¥
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
        else await signInAnonymously(auth);

        onAuthStateChanged(auth, u => {
            if(u) {
                currentUser = u;
                const statusEl = document.getElementById('connection-status');
                statusEl.innerText = "â— ä¼ºæœå™¨é€£ç·š";
                statusEl.classList.remove('offline');
                statusEl.classList.add('online');
                
                // å•Ÿç”¨å¤šäººæŒ‰éˆ•
                const btn = document.getElementById('btn-multi');
                btn.disabled = false;
                btn.innerText = "å¤šäººé€£ç·š (PvP)";
            }
        });

        // ç¶å®šçœŸå¯¦çš„æˆ¿é–“åŠŸèƒ½
        function getRef(code) { return doc(db, 'artifacts', appId, 'public', 'data', 'rooms', 'room_'+code); }

        window.createRoom = async () => {
            if(!currentUser) return;
            const code = Math.floor(1000 + Math.random()*9000).toString();
            currentRoomId = code; myRole = 'p1';
            document.getElementById('lobby-main').classList.add('hidden');
            document.getElementById('lobby-wait').classList.remove('hidden');
            document.getElementById('room-code-display').innerText = code;
            
            await setDoc(getRef(code), {
                status: 'waiting', p1: currentUser.uid, p2: null,
                p1_act: null, p2_act: null, p1_hp: 100, p1_en: 0, p2_hp: 100, p2_en: 0, ts: Date.now()
            });
            setupListener(code);
        };

        window.joinRoom = async () => {
            if(!currentUser) return;
            const code = document.getElementById('room-input').value.trim();
            if(code.length!==4) return alert("è«‹è¼¸å…¥4ä½æ•¸å­—");
            const ref = getRef(code);
            const snap = await getDoc(ref);
            if(!snap.exists()) return alert("æˆ¿é–“ä¸å­˜åœ¨");
            if(snap.data().p2) return alert("æˆ¿é–“å·²æ»¿");
            await updateDoc(ref, { p2: currentUser.uid, status: 'playing' });
            currentRoomId = code; myRole = 'p2';
            startGame('multi');
            setupListener(code);
        };

        function setupListener(code) {
            onSnapshot(getRef(code), (snap) => {
                if(snap.exists()) window.handleSync(snap.data(), myRole);
            });
        }

        window.sendAction = async (act) => {
            if(!currentRoomId) return;
            const up = {}; up[myRole+'_act'] = act;
            await updateDoc(getRef(currentRoomId), up);
        };

        window.syncState = async (s) => {
            if(myRole !== 'p1') return;
            await updateDoc(getRef(currentRoomId), {
                p1_act: null, p2_act: null,
                p1_hp: s.p1_hp, p1_en: s.p1_en,
                p2_hp: s.p2_hp, p2_en: s.p2_en,
                ts: Date.now()
            });
        };

        window.resetRoom = async () => {
            if(myRole !== 'p1') return;
            await updateDoc(getRef(currentRoomId), {
                p1_hp: 100, p1_en: 0, p2_hp: 100, p2_en: 0,
                p1_act: null, p2_act: null, status: 'playing', ts: Date.now()
            });
        };

    } catch (e) {
        console.log("é›¢ç·šæ¨¡å¼å·²å•Ÿå‹• (ç„¡ Firebase)");
        // ä¿æŒé›¢ç·šç‹€æ…‹ï¼Œä¸å ±éŒ¯ï¼Œå–®äººæ¨¡å¼ä¾ç„¶å¯ç”¨
    }
</script>

<script>
// --- éŠæˆ²å¼•æ“ (Canvas) ---
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const CLR = { BLUE:'#00FFFF', RED:'#FF3250', YEL:'#FFE600', PUR:'#B400FF', WHT:'#FFFFFF', GRY:'#444', BG:'#0F0F19' };
const DMG = { attack:10, skill1:20, skill2:35, skill3:60 };
// [ä¿®å¾©] è£œå›ç¼ºå¤±çš„å¸¸é‡å®šç¾©
const MAX_HP = 100;
const MAX_EN = 8;

// éŸ³æ•ˆ
const AudioContext = window.AudioContext || window.webkitAudioContext;
let actx, musicOn=true, sfxOn=true;
function initSfx() { if(!actx) actx = new AudioContext(); if(actx.state==='suspended') actx.resume(); }
const Sound = {
    play: (f,t,d,v=0.1) => { if(!sfxOn||!actx)return; const o=actx.createOscillator(), g=actx.createGain(); o.type=t; o.frequency.value=f; g.gain.value=v; g.gain.exponentialRampToValueAtTime(0.01, actx.currentTime+d); o.connect(g); g.connect(actx.destination); o.start(); o.stop(actx.currentTime+d); },
    click: ()=>Sound.play(800,'square',0.1,0.05),
    hit: ()=>Sound.play(100,'sawtooth',0.2,0.2),
    heavy: ()=>Sound.play(60,'square',0.4,0.3),
    block: ()=>Sound.play(1200,'triangle',0.2,0.1),
    sBlock: ()=>Sound.play(200,'sawtooth',0.4,0.2),
    charge: ()=>Sound.play(400,'sine',0.3,0.1),
    win: ()=>Sound.play(600,'square',0.5,0.2)
};
const BGM = {
    on: false, t: null,
    start: function(){ if(this.on||!musicOn)return; initSfx(); this.on=true; this.loop(); },
    stop: function(){ this.on=false; clearTimeout(this.t); },
    loop: function(){ if(!this.on)return; if(actx && sfxOn) Sound.play(80,'sawtooth',0.1,0.05); this.t=setTimeout(()=>this.loop(), 500); }
};

let mode = 'single', state = 0, timer = 0, mouse = {x:0,y:0};
const ST = { INPUT:0, ANIM:1, RESOLVE:2, OVER:3 };
let p1 = {hp:100, en:0, x:250, y:320, state:'idle', shake:0, flash:0};
let p2 = {hp:100, en:0, x:650, y:320, state:'idle', shake:0, flash:0};
let p1Act = null, p2Act = null, msg = "";
let fx = [], txts = [];

class Btn {
    constructor(t,x,y,c,a,cost=0){this.t=t;this.r={x,y,w:100,h:50};this.c=c;this.a=a;this.cost=cost;}
    draw(en, active){
        const dis = en<this.cost || !active;
        const col = dis ? CLR.GRY : this.c;
        const hov = !dis && this.hit(mouse);
        ctx.fillStyle = hov ? CLR.WHT : col;
        if(hov) ctx.fillRect(this.r.x-2, this.r.y-2, this.r.w+4, this.r.h+4);
        ctx.fillStyle = col; ctx.fillRect(this.r.x, this.r.y, this.r.w, this.r.h);
        ctx.strokeStyle = hov ? CLR.WHT : (dis ? '#555' : this.c);
        ctx.lineWidth = 2; ctx.strokeRect(this.r.x, this.r.y, this.r.w, this.r.h);
        ctx.fillStyle = dis ? '#888' : '#000';
        ctx.font = "bold 16px 'Noto Sans TC'";
        ctx.textAlign = "center"; ctx.textBaseline = "middle";
        ctx.fillText(this.t, this.r.x+50, this.r.y+25);
        if(this.cost>0){ ctx.fillStyle = dis ? '#888' : '#fff'; ctx.font = "12px sans-serif"; ctx.fillText(`æ°£${this.cost}`, this.r.x+85, this.r.y+40); }
    }
    hit(p){return p.x>=this.r.x && p.x<=this.r.x+100 && p.y>=this.r.y && p.y<=this.r.y+50;}
    check(p,en){return this.hit(p) && en>=this.cost;}
}

const BTNS = [
    new Btn("é›†æ°£",40,420,CLR.YEL,"charge"), new Btn("é˜²ç¦¦",150,420,CLR.BLUE,"block"), new Btn("è¶…ç´šé˜²å®ˆ",260,420,CLR.PUR,"s_block"),
    new Btn("æ©Ÿæ¢°åˆºæ‹³",370,420,CLR.RED,"attack"), new Btn("éŸ³é€Ÿè¡æ“Š",480,420,CLR.ORANGE,"skill1",1), new Btn("é›·éœ†é‡æ“Š",590,420,'#FF6400',"skill2",2), new Btn("çµ‚æ¥µå´©å£",700,420,'#FF0000',"skill3",3)
];

// æ ¸å¿ƒ
window.startGame = (m) => {
    initSfx(); BGM.start(); Sound.click();
    mode = m;
    p1 = {hp:MAX_HP, en:0, x:250, y:320, state:'idle', shake:0, flash:0};
    p2 = {hp:MAX_HP, en:0, x:650, y:320, state:'idle', shake:0, flash:0};
    particles=[]; floatingTexts=[];
    state = ST.INPUT;
    
    document.querySelectorAll('.ui-layer').forEach(e=>e.classList.add('hidden'));
    
    if(m === 'single') {
        msg = "å–®äººæ¨¡å¼ï¼šè«‹ä¸‹æŒ‡ä»¤";
        document.getElementById('room-info').style.display = 'none';
        window.callGeminiCommentary("Game Start! Cyberpunk Boxing match begins!");
    } else {
        msg = "é€£ç·šæˆåŠŸï¼ç­‰å¾…é›™æ–¹å‡ºæ‹›";
        const rInfo = document.getElementById('room-info');
        rInfo.style.display = 'block';
        rInfo.innerText = `Room: ${window.currentRoomId}`;
    }
};

window.restartGame = () => {
    document.getElementById('ui-result').classList.add('hidden');
    if(mode === 'multi' && window.resetRoom) window.resetRoom();
    else { startGame('single'); }
};

window.handleSync = (data, role) => {
    if(data.status==='waiting') return;
    if(data.status==='playing' && !document.getElementById('ui-lobby').classList.contains('hidden')) startGame('multi');
    p1.hp = data.p1_hp; p1.en = data.p1_en; p2.hp = data.p2_hp; p2.en = data.p2_en;
    const myAct = role==='p1' ? data.p1_act : data.p2_act;
    if(data.p1_act && data.p2_act) {
        if(state === ST.INPUT) {
            p1Act = data.p1_act; p2Act = data.p2_act;
            setState(p1, p1Act); setState(p2, p2Act);
            state = ST.ANIM; timer = 0; msg = "äº¤é‹’æ™‚åˆ»ï¼";
        }
    } else {
        if(state!==ST.ANIM && state!==ST.RESOLVE && state!==ST.OVER) {
            state = ST.INPUT;
            if(!myAct) msg = "ä½ çš„å›åˆï¼šè«‹é¸æ“‡è¡Œå‹•"; else msg = "å·²é–å®šï¼Œç­‰å¾…å°æ‰‹...";
        }
    }
};

function loop() {
    ctx.fillStyle = CLR.BG; ctx.fillRect(0,0,900,600);
    let ox = 0, oy = 0;
    if(p1.shake>0 || p2.shake>0) { ox = (Math.random()-0.5)*10; oy = (Math.random()-0.5)*10; p1.shake*=0.9; p2.shake*=0.9; }
    
    ctx.strokeStyle = '#28003C'; ctx.lineWidth=1;
    for(let i=-200; i<1100; i+=50) { ctx.beginPath(); ctx.moveTo(i+ox*0.5, 400+oy); ctx.lineTo(i-300+(i/900)*600+ox, 600+oy); ctx.stroke(); }
    ctx.strokeStyle = '#C0C'; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(0,400+oy); ctx.lineTo(900,400+oy); ctx.stroke();

    drawFighter(p1, true, ox, oy); drawFighter(p2, false, ox, oy);
    fx.forEach((f,i) => { f.y+=f.vy; f.vy+=0.5; f.life--; if(f.life>0){ctx.fillStyle=f.c;ctx.fillRect(f.x+ox,f.y+oy,4,4);} else fx.splice(i,1); });
    txts.forEach((t,i) => { t.y-=1; t.life--; if(t.life>0){ctx.fillStyle=t.c;ctx.font="bold 24px sans-serif";ctx.fillText(t.t,t.x+ox,t.y+oy);} else txts.splice(i,1); });

    if(state === ST.INPUT) {
        ctx.fillStyle = "rgba(20,20,30,0.8)"; ctx.fillRect(0,400,900,120);
        ctx.strokeStyle = CLR.BLUE; ctx.strokeRect(0,400,900,120);
        let active = true; let myEn = p1.en;
        if(mode === 'multi') {
            const r = window.myRole || 'p1';
            myEn = (r === 'p1') ? p1.en : p2.en;
            if(msg.includes("ç­‰å¾…") || msg.includes("å·²é–å®š")) active = false;
        }
        BTNS.forEach(b => b.draw(myEn, active));
    }
    else if(state === ST.ANIM) {
        timer++; if(timer > 40) { resolveTurn(); state = ST.RESOLVE; timer = 0; }
    }
    else if(state === ST.RESOLVE) {
        timer++;
        if(timer > 60) {
            setState(p1, 'idle'); setState(p2, 'idle');
            if(p1.hp<=0 || p2.hp<=0) {
                state = ST.OVER;
                let t = "DRAW";
                if(p1.hp>0) { t = mode==='single'?"YOU WIN":"P1 WINS"; Sound.win(); }
                else if(p2.hp>0) { t = mode==='single'?"YOU LOSE":"P2 WINS"; }
                document.getElementById('result-title').innerText = t;
                document.getElementById('ui-result').classList.remove('hidden');
                window.callGeminiCommentary(`Game Over! ${t}. Describe the ending.`);
            } else {
                state = ST.INPUT; msg = "ä¸‹ä¸€å›åˆ";
                if(mode==='multi' && window.syncState) window.syncState({p1_hp:p1.hp, p1_en:p1.en, p2_hp:p2.hp, p2_en:p2.en});
            }
        }
    }

    drawHUD(20, 20, p1, CLR.BLUE, "PLAYER 1"); drawHUD(660, 20, p2, CLR.RED, "PLAYER 2");
    ctx.fillStyle = CLR.WHT; ctx.font = "bold 24px 'Noto Sans TC'"; ctx.textAlign = "center"; ctx.fillText(msg, 450, 80);
    requestAnimationFrame(loop);
}

function drawFighter(p, isP1, ox, oy) {
    let x = p.x + (Math.random()-0.5)*p.shake + ox; let y = p.y + oy; let c = isP1 ? CLR.BLUE : CLR.RED;
    if(p.flash>0) { c = CLR.WHT; p.flash--; }
    ctx.save(); ctx.translate(x, y); if(!isP1) ctx.scale(-1, 1);
    ctx.strokeStyle = c; ctx.lineWidth = 4; ctx.lineCap = "round";
    const b = Math.sin(Date.now()/300)*2;
    ctx.beginPath();
    if(p.state === 'charge') {
        ctx.moveTo(-20,0); ctx.lineTo(-10,-30); ctx.lineTo(0,-50); ctx.lineTo(10,-30); ctx.lineTo(20,0);
        ctx.moveTo(0,-50); ctx.lineTo(10,-90); ctx.moveTo(10,-80); ctx.lineTo(30,-70); ctx.lineTo(10,-60);
        ctx.moveTo(25,-105); ctx.arc(15,-105,10,0,Math.PI*2);
    } else {
        ctx.moveTo(-20,0); ctx.lineTo(-10,-50); ctx.lineTo(0,-80+b); ctx.lineTo(10,-50); ctx.lineTo(20,0);
        ctx.moveTo(0,-80+b); ctx.lineTo(0,-130+b);
        if(p.state === 'attack') { ctx.moveTo(0,-120+b); ctx.lineTo(40,-120+b); ctx.lineTo(80,-120+b); }
        else if(p.state.includes('block')) { ctx.moveTo(0,-120+b); ctx.lineTo(20,-110+b); ctx.lineTo(20,-140+b); }
        else { ctx.moveTo(0,-120+b); ctx.lineTo(15,-100+b); ctx.lineTo(25,-125+b); }
        ctx.moveTo(10,-145+b); ctx.arc(0,-145+b,10,0,Math.PI*2);
    }
    ctx.stroke();
    if(p.state === 'block') { ctx.strokeStyle=CLR.BLUE; ctx.strokeRect(30,-150,5,100); }
    if(p.state === 's_block') { ctx.strokeStyle=CLR.PUR; ctx.beginPath(); ctx.arc(0,-80,70,0,Math.PI*2); ctx.stroke(); }
    if(p.state === 'charge') { ctx.strokeStyle=CLR.YEL; ctx.beginPath(); ctx.arc(10,-60,50,0,Math.PI*2); ctx.stroke(); }
    ctx.restore();
}

function drawHUD(x, y, p, c, name) {
    ctx.fillStyle = c; ctx.font = "bold 16px sans-serif"; ctx.textAlign = "left"; ctx.fillText(name, x, y);
    ctx.fillStyle = "#333"; ctx.fillRect(x, y+10, 220, 20); ctx.fillStyle = c; ctx.fillRect(x, y+10, 220*(p.hp/MAX_HP), 20);
    ctx.strokeStyle = "#fff"; ctx.strokeRect(x, y+10, 220, 20);
    for(let i=0; i<MAX_EN; i++) { ctx.fillStyle = i<p.en ? CLR.YEL : "#333"; ctx.beginPath(); ctx.arc(x+15+i*25, y+45, 8, 0, Math.PI*2); ctx.fill(); ctx.strokeStyle = "#000"; ctx.stroke(); }
}

function setState(p, act) {
    if(act==='charge') p.state='charge'; else if(act==='block') p.state='block'; else if(act==='s_block') p.state='s_block';
    else if(act.includes('skill') || act==='attack') p.state='attack'; else p.state='idle';
}

function resolveTurn() {
    let comment = `P1 used ${p1Act}, P2 used ${p2Act}. `;
    // P1 -> P2
    if(["attack","skill1","skill2","skill3"].includes(p1Act)) {
        let dmg = DMG[p1Act], blocked = false;
        if(p1Act==="skill3") { if(p2Act==="s_block") blocked=true; } else { if(p2Act==="block") blocked=true; }
        if(blocked) { spawnText("æ ¼æ“‹!", p2.x, p2.y-100, CLR.BLUE); Sound.block(); comment+="P2 Blocked! "; }
        else { p2.hp-=dmg; p2.shake=20; p2.flash=5; spawnText("-"+dmg, p2.x, p2.y-100, CLR.RED); Sound.hit(); comment+=`P1 Hit ${dmg}! `; }
    }
    // P2 -> P1
    if(["attack","skill1","skill2","skill3"].includes(p2Act)) {
        let dmg = DMG[p2Act], blocked = false;
        if(p2Act==="skill3") { if(p1Act==="s_block") blocked=true; } else { if(p1Act==="block") blocked=true; }
        if(blocked) { spawnText("æ ¼æ“‹!", p1.x, p1.y-100, CLR.BLUE); Sound.block(); comment+="P1 Blocked! "; }
        else { p1.hp-=dmg; p1.shake=20; p1.flash=5; spawnText("-"+dmg, p1.x, p1.y-100, CLR.RED); Sound.hit(); comment+=`P2 Hit ${dmg}! `; }
    }
    handleCharge(p1, p1Act, p2Act); handleCharge(p2, p2Act, p1Act);
    
    if(p1Act!=='charge' || p2Act!=='charge') window.callGeminiCommentary(`Use Traditional Chinese to commentate this cyberpunk fight action: ${comment}. Keep it short and hype.`);
}

function handleCharge(p, myAct, opAct) {
    if(myAct !== 'charge' || p.hp <= 0) return;
    let interrupted = ["skill1","skill2","skill3"].includes(opAct);
    if(interrupted) spawnText("ä¸­æ–·!", p.x, p.y-150, CLR.GRY);
    else { p.en = Math.min(MAX_EN, p.en+1); spawnText("+1æ°£", p.x, p.y-150, CLR.YEL); Sound.charge(); }
}

function spawnParts(x,y,c){for(let i=0;i<10;i++)fx.push({x:x,y:y,vy:(Math.random()-0.5)*10,life:20,c:c});}
function spawnText(t,x,y,c,s=1){txts.push({t:t,x:x,y:y,c:c,life:50});}

canvas.addEventListener('mousemove', e => { const r = canvas.getBoundingClientRect(); mouse = {x: e.clientX - r.left, y: e.clientY - r.top}; });
canvas.addEventListener('mousedown', e => {
    if(state !== ST.INPUT) return;
    initSfx(); BGM.start();
    if(mode === 'multi' && (msg.includes("ç­‰å¾…") || msg.includes("å·²é–å®š"))) return;
    const role = window.myRole || 'p1';
    const myEn = (role === 'p1') ? p1.en : p2.en;
    for(let b of BTNS) {
        if(b.check(mouse, myEn)) {
            Sound.click();
            if(mode === 'single') {
                p1Action = b.a;
                let opts = ["attack","block"];
                if(p2.en>=1)opts.push("skill1"); if(p2.en>=2)opts.push("skill2"); if(p2.en>=3)opts.push("skill3"); if(p2.en==0)opts.push("charge");
                p2Act = opts[Math.floor(Math.random()*opts.length)];
                deductEn(p1, p1Action); deductEn(p2, p2Act);
                setState(p1, p1Action); setState(p2, p2Act);
                state = ST.ANIM; timer = 0;
            } else {
                if(window.sendAction) { window.sendAction(b.a); msg = "å·²é–å®šï¼Œç­‰å¾…å°æ‰‹..."; deductEn(role==='p1'?p1:p2, b.a); }
            }
            break;
        }
    }
});

function deductEn(p, act) {
    if(act==='skill1') p.en-=1; if(act==='skill2') p.en-=2; if(act==='skill3') p.en-=3; if(p.en<0) p.en=0;
}

document.getElementById('btn-music').onclick=function(){ musicOn=!musicOn; this.classList.toggle('active'); if(musicOn)BGM.start(); else BGM.stop(); };
document.getElementById('btn-sfx').onclick=function(){ sfxOn=!sfxOn; this.classList.toggle('active'); };

loop();
</script>
</body>
</html>
